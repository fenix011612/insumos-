<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Mensal de Insumos</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc,
    addDoc, getDocs, deleteDoc,
    serverTimestamp, query
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByv8SN7FXTKG9kc2jJCeYGMa86R0ZVf9g",
    authDomain: "insumos-41ece.firebaseapp.com",
    projectId: "insumos-41ece",
    storageBucket: "insumos-41ece.firebasestorage.app",
    messagingSenderId: "25863524219",
    appId: "1:25863524219:web:59fff88398f535f84437de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.fs = { collection, doc, addDoc, getDocs, deleteDoc, serverTimestamp, query };
</script>

<style>
:root{
  --lilas:#6a5acd;
  --ciano:#4fc3f7;
  --bg:#f7f5ff;
}
body{font-family:Poppins,Arial;background:var(--bg);padding:30px;}
h1{text-align:center;color:var(--lilas);}
.container{background:#fff;padding:20px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.08);}
table{width:100%;border-collapse:collapse;}
thead{background:var(--lilas);color:#fff;}
th,td{padding:8px;text-align:center;}
tbody tr:nth-child(even){background:#f2f2f2;}
button{background:var(--ciano);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-top:10px;}
.total{margin-top:20px;font-size:20px;font-weight:600;color:var(--lilas);text-align:center;}
</style>
</head>

<body>
<h1>Planilha Mensal de Insumos</h1>

<div class="container">
  <select id="mes"></select>
  <select id="ano"></select>

  <table>
    <thead>
      <tr>
        <th>Insumo</th>
        <th>Custo</th>
        <th>Qtd</th>
        <th>Data</th>
        <th>Local</th>
        <th>Pagamento</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <button id="add">+ Adicionar Insumo</button>
  <button id="apagar">ðŸ—‘ Apagar MÃªs</button>

  <div class="total" id="totalMes">Total do MÃªs: R$ 0,00</div>
</div>

<script type="module">
const meses=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const mes=document.getElementById('mes');
const ano=document.getElementById('ano');
const tabela=document.getElementById('tabela');
const totalMes=document.getElementById('totalMes');

meses.forEach((m,i)=>mes.innerHTML+=`<option value="${i}">${m}</option>`);
for(let a=2026;a<=2035;a++) ano.innerHTML+=`<option>${a}</option>`;

mes.value=new Date().getMonth();
ano.value=new Date().getFullYear();

function refMes(){
  return window.fs.collection(
    window.db,
    "insumos",
    ano.value,
    mes.value
  );
}

function calcular(){
  let soma=0;
  tabela.querySelectorAll('tr').forEach(tr=>{
    const c=Number(tr.children[1].querySelector('input').value)||0;
    const q=Number(tr.children[2].querySelector('input').value)||0;
    const t=c*q;
    tr.querySelector('.linhaTotal').textContent=t.toFixed(2);
    soma+=t;
  });
  totalMes.textContent=`Total do MÃªs: R$ ${soma.toFixed(2)}`;
}

async function carregar(){
  tabela.innerHTML='';
  const q=window.fs.query(refMes());
  const snap=await window.fs.getDocs(q);

  snap.forEach(docSnap=>{
    const d=docSnap.data();
    criarLinha(d, docSnap.id);
  });

  calcular();
}

function criarLinha(d={},id=null){
  const tr=document.createElement('tr');
  tr.dataset.id=id;

  tr.innerHTML=`
    <td><input value="${d.insumo||''}"></td>
    <td><input type="number" value="${d.custo||''}"></td>
    <td><input type="number" value="${d.quantidade||''}"></td>
    <td><input type="date" value="${d.data||''}"></td>
    <td><input value="${d.local||''}"></td>
    <td><input value="${d.pagamento||''}"></td>
    <td class="linhaTotal">0,00</td>
  `;

  tr.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('change', async ()=>{
      const dados={
        insumo:tr.children[0].querySelector('input').value,
        custo:tr.children[1].querySelector('input').value,
        quantidade:tr.children[2].querySelector('input').value,
        data:tr.children[3].querySelector('input').value,
        local:tr.children[4].querySelector('input').value,
        pagamento:tr.children[5].querySelector('input').value,
        criadoEm: window.fs.serverTimestamp()
      };

      if(tr.dataset.id){
        await window.fs.deleteDoc(
          window.fs.doc(refMes(), tr.dataset.id)
        );
      }

      const novo=await window.fs.addDoc(refMes(), dados);
      tr.dataset.id=novo.id;
      calcular();
    });
  });

  tabela.appendChild(tr);
}

document.getElementById('add').onclick=()=>criarLinha();

document.getElementById('apagar').onclick=async ()=>{
  if(!confirm('Apagar todos os dados deste mÃªs?')) return;
  const snap=await window.fs.getDocs(refMes());
  snap.forEach(d=>window.fs.deleteDoc(d.ref));
  tabela.innerHTML='';
  totalMes.textContent='Total do MÃªs: R$ 0,00';
};

mes.onchange=carregar;
ano.onchange=carregar;
carregar();
</script>
</body>
</html>
