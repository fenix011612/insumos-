<!DOCTYPE html><html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Planilha Mensal de Insumos</title>
<meta name="viewport" content="width=device-width, initial-scale=1"><style>
:root{
    --lilas:#6a5acd;
    --ciano:#4fc3f7;
    --bg:#f7f5ff;
    --branco:#ffffff;
}

body{
    margin:0;
    padding:20px;
    font-family:Poppins, Arial, sans-serif;
    background:var(--bg);
}

h1, h2{
    text-align:center;
    color:var(--lilas);
}

.container{
    max-width:1300px;
    margin:auto;
    background:var(--branco);
    padding:20px;
    border-radius:14px;
    box-shadow:0 6px 20px rgba(0,0,0,0.1);
}

.filtros{
    display:flex;
    gap:10px;
    margin-bottom:15px;
    flex-wrap:wrap;
}

select{
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
}

table{
    width:100%;
    border-collapse:collapse;
}

th{
    background:var(--lilas);
    color:white;
    padding:10px;
    font-size:14px;
}

td{
    padding:8px;
    border-bottom:1px solid #ddd;
}

input, select{
    width:100%;
    padding:6px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:14px;
    pointer-events:auto;
    background:#fff;
}

.total{
    background:#eef6ff;
    font-weight:bold;
}

.btn{
    margin-top:15px;
    padding:10px 16px;
    border:none;
    border-radius:8px;
    background:var(--ciano);
    font-weight:600;
    cursor:pointer;
}

.resumo{
    margin-top:20px;
    background:#f2f0ff;
    padding:15px;
    border-radius:10px;
}

.comparativo{
    margin-top:20px;
}
</style></head>
<body><h1>Planilha Mensal de Insumos</h1><div class="container"><table>
<thead>
<tr>
<th>Insumo (edit√°vel)</th>
<th>Custo</th>
<th>Qtd</th>
<th>Data</th>
<th>Local</th>
<th>Pagamento</th>
<th>Total</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table><button class="btn" onclick="adicionarLinha()">+ Adicionar Insumo</button>

<div class="resumo">
<h2>Total do M√™s: R$ <span id="totalMes">0,00</span></h2>
</div><div class="comparativo">
<h2>Comparativo de Gastos por M√™s</h2>
<ul id="listaComparativo"></ul>
<button class="btn" onclick="apagarHistorico()">üóëÔ∏è Apagar Hist√≥rico</button>
</div></div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

window.addEventListener('DOMContentLoaded', () => {

const firebaseConfig = {
  apiKey: "AIzaSyByv8SN7FXTKG9kc2jJCeYGMa86R0ZVf9g",
  authDomain: "insumos-41ece.firebaseapp.com",
  projectId: "insumos-41ece",
  storageBucket: "insumos-41ece.firebasestorage.app",
  messagingSenderId: "25863524219",
  appId: "1:25863524219:web:59fff88398f535f84437de"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabela = document.getElementById('tabela');
const mesSelect = document.getElementById('mes');
const anoSelect = document.getElementById('ano');
const totalMesEl = document.getElementById('totalMes');
const listaComparativo = document.getElementById('listaComparativo');

const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

function init(){
  meses.forEach((m,i)=>{
    const op=document.createElement('option');
    op.value=i; op.textContent=m; mesSelect.appendChild(op);
  });
  const anoAtual=new Date().getFullYear();
  for(let a=2026;a<=anoAtual+5;a++){
    const op=document.createElement('option');
    op.value=a; op.textContent=a; anoSelect.appendChild(op);
}
  carregarTabela();
}

function chave(){ return `${anoSelect.value}-${mesSelect.value}`; }

async async function carregarTabela(){
  tabela.innerHTML='';
  const ref = doc(db,'insumos',chave());
  const snap = await getDoc(ref);
  const linhas = snap.exists() ? snap.data().linhas : [];

  if(linhas.length === 0){
    tabela.appendChild(criarLinha());
    totalMesEl.textContent = '0.00';
    return;
  }

  linhas.forEach(l => tabela.appendChild(criarLinha(l)));
  calcularTotalMes();
} else {
    linhas.forEach(l => tabela.appendChild(criarLinha(l)));
  }
  calcularTotalMes();
}

function criarLinha(d={}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input></td>
    <td><input type="number" step="0.01"></td>
    <td><input type="number"></td>
    <td><input type="date"></td>
    <td><input></td>
    <td><input></td>
    <td class="total">0,00</td>`;

  const i=tr.querySelectorAll('input');
  i[0].value=d.insumo||'';
  i[1].value=d.custo||'';
  i[2].value=d.qtd||'';
  i[3].value=d.data||'';
  i[4].value=d.local||'';
  i[5].value=d.pagamento||'';

  i.forEach(inp=>inp.addEventListener('input', salvar));
  return tr;
}

function adicionarLinha(){ tabela.appendChild(criarLinha()); }
window.adicionarLinha = adicionarLinha;

let salvando = false;
let timeoutSalvar;
async function salvar(){
  clearTimeout(timeoutSalvar);
  timeoutSalvar = setTimeout(async ()=>{
    if(salvando) return;
    salvando = true;

    const linhas=[];
    let totalMes = 0;

    tabela.querySelectorAll('tr').forEach(tr=>{
      const i = tr.querySelectorAll('input');
      const custo = parseFloat(i[1].value) || 0;
      const qtd = parseFloat(i[2].value) || 0;
      const totalLinha = custo * qtd;

      tr.querySelector('.total').textContent = totalLinha.toFixed(2);
      totalMes += totalLinha;

      linhas.push({
        insumo: i[0].value,
        custo,
        qtd,
        data: i[3].value,
        local: i[4].value,
        pagamento: i[5].value
      });
    });

    totalMesEl.textContent = totalMes.toFixed(2);
    await setDoc(doc(db,'insumos',chave()), { linhas });
    salvando = false;
  }, 300);
}(doc(db,'insumos',chave()), { linhas });
  salvando = false;
});
  });
  await setDoc(doc(db,'insumos',chave()),{linhas});
  calcularTotalMes();
}

function calcularTotalMes(){
  let t=0;
  tabela.querySelectorAll('.total').forEach(td=>t+=parseFloat(td.textContent)||0);
  totalMesEl.textContent=t.toFixed(2);
}

async function atualizarComparativo(){
  listaComparativo.innerHTML='';
  const snap = await getDocs(collection(db,'insumos'));
  const ranking = [];

  snap.forEach(docu=>{
    const soma = docu.data().linhas.reduce((s,l)=>s+(l.custo*l.qtd||0),0);
    ranking.push({mes:docu.id,total:soma});
  });

  ranking.sort((a,b)=>b.total-a.total);
  ranking.forEach(r=>{
    const li=document.createElement('li');
    li.textContent = `${r.mes} ‚Üí R$ ${r.total.toFixed(2)}`;
    listaComparativo.appendChild(li);
  });
}

async function apagarHistorico(){
  if(!confirm('Tem certeza que deseja apagar TODO o hist√≥rico?')) return;

  const snap = await getDocs(collection(db,'insumos'));
  for (const d of snap.docs) {
    await deleteDoc(doc(db,'insumos', d.id));
  }

  tabela.innerHTML='';
  tabela.appendChild(criarLinha());
  totalMesEl.textContent='0.00';
  listaComparativo.innerHTML='';
});
  });
  tabela.innerHTML='';
  tabela.appendChild(criarLinha());
  totalMesEl.textContent='0.00';
  atualizarComparativo();
});
  });
  ranking.sort((a,b)=>b.total-a.total);
  ranking.forEach(r=>{
    const li=document.createElement('li');
    li.textContent=`${r.mes} ‚Üí R$ ${r.total.toFixed(2)}`;
    listaComparativo.appendChild(li);
  });
}

mesSelect.addEventListener('change',carregarTabela);
anoSelect.addEventListener('change',carregarTabela);

init();

window.apagarHistorico = apagarHistorico;
});
</script></body>
</html>
