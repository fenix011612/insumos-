<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Insumos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f7fa;
    }
    input, button {
      padding: 8px;
      margin: 4px 0;
      width: 100%;
    }
    button {
      background: #2ecc71;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: white;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 4px;
    }
    canvas {
      margin-top: 20px;
      background: white;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>

<body>

<h2>Cadastro de Insumos</h2>

<input id="nome" placeholder="Nome do insumo">
<input id="categoria" placeholder="Categoria">
<input id="valor" type="number" placeholder="Valor">
<input id="quantidade" type="number" placeholder="Quantidade">

<button id="btnSalvar">Salvar Insumo</button>

<hr>

<h3>Total do m√™s: <span id="totalMes">R$ 0,00</span></h3>

<ul id="lista"></ul>

<canvas id="graficoGastos"></canvas>

<!-- APP -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // üî• CONFIG FIREBASE (ajuste apenas isso)
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_DOMINIO.firebaseapp.com",
    projectId: "insumos-41ece"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // üîπ ELEMENTOS
  const lista = document.getElementById("lista");
  const totalMesEl = document.getElementById("totalMes");
  const btnSalvar = document.getElementById("btnSalvar");

  let grafico = null;

  // üîπ SALVAR INSUMO (CRIA COLE√á√ÉO AUTOMATICAMENTE)
  btnSalvar.addEventListener("click", async () => {
    const nome = document.getElementById("nome").value;
    const categoria = document.getElementById("categoria").value;
    const valor = Number(document.getElementById("valor").value);
    const quantidade = Number(document.getElementById("quantidade").value);

    if (!nome || !valor || !quantidade) {
      alert("Preencha todos os campos");
      return;
    }

    const hoje = new Date();
    const mesAno = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, "0")}`;

    await addDoc(collection(db, "insumos"), {
      nome,
      categoria,
      valor,
      quantidade,
      data: Timestamp.fromDate(hoje),
      mesAno
    });

    document.getElementById("nome").value = "";
    document.getElementById("categoria").value = "";
    document.getElementById("valor").value = "";
    document.getElementById("quantidade").value = "";
  });

  // üîπ CARREGAR INSUMOS (N√ÉO SOME AO ATUALIZAR)
  onSnapshot(collection(db, "insumos"), (snapshot) => {
    lista.innerHTML = "";
    let totalMes = 0;
    const dadosGrafico = {};

    snapshot.forEach(doc => {
      const d = doc.data();

      totalMes += d.valor * d.quantidade;

      const li = document.createElement("li");
      li.innerText = `${d.nome} (${d.categoria}) - R$ ${(d.valor * d.quantidade).toFixed(2)}`;
      lista.appendChild(li);

      dadosGrafico[d.nome] =
        (dadosGrafico[d.nome] || 0) + (d.valor * d.quantidade);
    });

    totalMesEl.innerText = `R$ ${totalMes.toFixed(2)}`;

    montarGrafico(dadosGrafico);
  });

  // üîπ GR√ÅFICO
  function montarGrafico(dados) {
    const ctx = document.getElementById("graficoGastos");

    if (grafico) grafico.destroy();

    grafico = new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(dados),
        datasets: [{
          label: "Gastos por insumo",
          data: Object.values(dados)
        }]
      }
    });
  }
</script>

</body>
</html>
