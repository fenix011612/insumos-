<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Mensal de Insumos</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, doc,
  addDoc, getDocs, setDoc, deleteDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyByv8SN7FXTKG9kc2jJCeYGMa86R0ZVf9g",
  authDomain: "insumos-41ece.firebaseapp.com",
  projectId: "insumos-41ece",
  storageBucket: "insumos-41ece.firebasestorage.app",
  messagingSenderId: "25863524219",
  appId: "1:25863524219:web:59fff88398f535f84437de"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
window.fs = { collection, doc, addDoc, getDocs, setDoc, deleteDoc, serverTimestamp };
</script>

<style>
:root{
  --lilas:#6a5acd;
  --ciano:#4fc3f7;
  --bg:#f7f5ff;
}
body{font-family:Poppins,Arial;background:var(--bg);padding:30px;}
h1{text-align:center;color:var(--lilas);}
.container{background:#fff;padding:20px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.08);}
table{width:100%;border-collapse:collapse;}
thead{background:var(--lilas);color:#fff;}
th,td{padding:8px;text-align:center;}
tbody tr:nth-child(even){background:#f2f2f2;}
button{background:var(--ciano);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-top:10px;}
.total{margin-top:20px;font-size:20px;font-weight:600;color:var(--lilas);text-align:center;}
.resumo{margin-top:15px;background:#f1efff;padding:12px;border-radius:10px;}
</style>
</head>

<body>
<h1>Planilha Mensal de Insumos</h1>

<div class="container">
  <select id="mes"></select>
  <select id="ano"></select>

  <table>
    <thead>
      <tr>
        <th>Insumo</th>
        <th>Custo</th>
        <th>Qtd</th>
        <th>Data</th>
        <th>Local</th>
        <th>Pagamento</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <button id="add">+ Adicionar Insumo</button>

  <div class="total" id="totalMes">Total do Mês: R$ 0,00</div>
  <div class="resumo" id="resumo"></div>
</div>

<script type="module">
const meses=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const mes=document.getElementById('mes');
const ano=document.getElementById('ano');
const tabela=document.getElementById('tabela');
const totalMes=document.getElementById('totalMes');
const resumo=document.getElementById('resumo');

meses.forEach((m,i)=>mes.innerHTML+=`<option value="${i}">${m}</option>`);
for(let a=2026;a<=2035;a++) ano.innerHTML+=`<option>${a}</option>`;

mes.value=new Date().getMonth();
ano.value=new Date().getFullYear();

function refMes(){
  return window.fs.collection(window.db,"insumos",ano.value,mes.value);
}

function criarLinha(d={},id=null){
  const tr=document.createElement('tr');
  tr.dataset.id=id||'';

  tr.innerHTML=`
    <td><input value="${d.insumo||''}"></td>
    <td><input type="number" value="${d.custo||''}"></td>
    <td><input type="number" value="${d.quantidade||''}"></td>
    <td><input type="date" value="${d.data||''}"></td>
    <td><input value="${d.local||''}"></td>
    <td><input value="${d.pagamento||''}"></td>
    <td class="linhaTotal">0.00</td>
  `;

  const inputs=tr.querySelectorAll('input');

  inputs.forEach(inp=>{
    inp.addEventListener('input', async ()=>{
      const custo=Number(inputs[1].value)||0;
      const qtd=Number(inputs[2].value)||0;
      const total=custo*qtd;
      tr.querySelector('.linhaTotal').textContent=total.toFixed(2);

      const dados={
        insumo:inputs[0].value,
        custo,
        quantidade:qtd,
        total,
        data:inputs[3].value,
        local:inputs[4].value,
        pagamento:inputs[5].value,
        atualizadoEm:window.fs.serverTimestamp()
      };

      if(tr.dataset.id){
        await window.fs.setDoc(
          window.fs.doc(refMes(),tr.dataset.id),
          dados,
          {merge:true}
        );
      }else{
        const novo=await window.fs.addDoc(refMes(),{
          ...dados,
          criadoEm:window.fs.serverTimestamp()
        });
        tr.dataset.id=novo.id;
      }

      await atualizarResumo();
      calcularTotal();
    });
  });

  tabela.appendChild(tr);
}

async function carregar(){
  tabela.innerHTML='';
  const snap=await window.fs.getDocs(refMes());
  snap.forEach(d=>{
    criarLinha(d.data(),d.id);
  });
  calcularTotal();
  atualizarResumo();
}

function calcularTotal(){
  let soma=0;
  tabela.querySelectorAll('.linhaTotal').forEach(td=>{
    soma+=Number(td.textContent)||0;
  });
  totalMes.textContent=`Total do Mês: R$ ${soma.toFixed(2)}`;
}

async function atualizarResumo(){
  const snap=await window.fs.getDocs(refMes());
  let total=0;
  const mapa={};

  snap.forEach(d=>{
    const i=d.data();
    total+=i.total||0;
    if(!mapa[i.insumo]) mapa[i.insumo]={vezes:0,valor:0};
    mapa[i.insumo].vezes++;
    mapa[i.insumo].valor+=i.total||0;
  });

  const ranking=Object.entries(mapa)
    .map(([k,v])=>({insumo:k,...v}))
    .sort((a,b)=>b.vezes-a.vezes);

  resumo.innerHTML=`
    <b>Total do mês:</b> R$ ${total.toFixed(2)}<br>
    <b>Insumo mais comprado:</b> ${ranking[0]?.insumo||'-'}
  `;
}

document.getElementById('add').onclick=()=>criarLinha();
mes.onchange=carregar;
ano.onchange=carregar;

carregar();
</script>
</body>
</html>
