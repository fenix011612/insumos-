<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilha Mensal de Insumos</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc,
    addDoc, getDocs, deleteDoc,
    setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByv8SN7FXTKG9kc2jJCeYGMa86R0ZVf9g",
    authDomain: "insumos-41ece.firebaseapp.com",
    projectId: "insumos-41ece",
    storageBucket: "insumos-41ece.firebasestorage.app",
    messagingSenderId: "25863524219",
    appId: "1:25863524219:web:59fff88398f535f84437de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.fs = { collection, doc, addDoc, getDocs, deleteDoc, setDoc, serverTimestamp };
</script>

<style>
:root{
  --lilas:#6a5acd;
  --ciano:#4fc3f7;
  --bg:#f7f5ff;
}
body{font-family:Poppins,Arial;background:var(--bg);padding:30px;}
h1{text-align:center;color:var(--lilas);}
.container{background:#fff;padding:20px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.08);}
table{width:100%;border-collapse:collapse;}
thead{background:var(--lilas);color:#fff;}
th,td{padding:8px;text-align:center;}
tbody tr:nth-child(even){background:#f2f2f2;}
button{background:var(--ciano);border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-top:10px;}
.total{margin-top:20px;font-size:20px;font-weight:600;color:var(--lilas);text-align:center;}
.resumo{margin-top:20px;background:#f1efff;padding:15px;border-radius:10px;}
</style>
</head>

<body>
<h1>Planilha Mensal de Insumos</h1>

<div class="container">
  <select id="mes"></select>
  <select id="ano"></select>

  <table>
    <thead>
      <tr>
        <th>Insumo</th>
        <th>Custo</th>
        <th>Qtd</th>
        <th>Data</th>
        <th>Local</th>
        <th>Pagamento</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <button id="add">+ Adicionar Insumo</button>
  <button id="apagar">ðŸ—‘ Apagar MÃªs</button>

  <div class="total" id="totalMes">Total do MÃªs: R$ 0,00</div>
  <div class="resumo" id="resumo"></div>
</div>

<script type="module">
const meses=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const mes=document.getElementById('mes');
const ano=document.getElementById('ano');
const tabela=document.getElementById('tabela');
const totalMes=document.getElementById('totalMes');
const resumoDiv=document.getElementById('resumo');

meses.forEach((m,i)=>mes.innerHTML+=`<option value="${i}">${m}</option>`);
for(let a=2026;a<=2035;a++) ano.innerHTML+=`<option>${a}</option>`;

mes.value=new Date().getMonth();
ano.value=new Date().getFullYear();

function refMes(){
  return window.fs.collection(window.db,"insumos",ano.value,mes.value);
}

function calcular(){
  let soma=0;
  tabela.querySelectorAll('tr').forEach(tr=>{
    soma+=Number(tr.querySelector('.linhaTotal').textContent)||0;
  });
  totalMes.textContent=`Total do MÃªs: R$ ${soma.toFixed(2)}`;
}

function criarLinha(d={}){
  const tr=document.createElement('tr');

  tr.innerHTML=`
    <td><input value="${d.insumo||''}"></td>
    <td><input type="number" value="${d.custo||''}"></td>
    <td><input type="number" value="${d.quantidade||''}"></td>
    <td><input type="date" value="${d.data||''}"></td>
    <td><input value="${d.local||''}"></td>
    <td><input value="${d.pagamento||''}"></td>
    <td class="linhaTotal">0.00</td>
  `;

  tr.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', async ()=>{
      const custo=Number(tr.children[1].querySelector('input').value)||0;
      const qtd=Number(tr.children[2].querySelector('input').value)||0;
      const total=custo*qtd;
      tr.querySelector('.linhaTotal').textContent=total.toFixed(2);

      await window.fs.addDoc(refMes(),{
        insumo:tr.children[0].querySelector('input').value,
        custo,qtd,quantidade:qtd,total,
        data:tr.children[3].querySelector('input').value,
        local:tr.children[4].querySelector('input').value,
        pagamento:tr.children[5].querySelector('input').value,
        criadoEm:window.fs.serverTimestamp()
      });

      await atualizarResumoMensal();
      calcular();
    });
  });

  tabela.appendChild(tr);
}

async function atualizarResumoMensal(){
  const snap=await window.fs.getDocs(refMes());
  let totalGasto=0;
  const mapa={};

  snap.forEach(d=>{
    const i=d.data();
    totalGasto+=i.total||0;

    if(!mapa[i.insumo]) mapa[i.insumo]={vezes:0,valor:0};
    mapa[i.insumo].vezes++;
    mapa[i.insumo].valor+=i.total||0;
  });

  const ranking=Object.entries(mapa).map(([k,v])=>({insumo:k,...v}))
    .sort((a,b)=>b.vezes-a.vezes);

  // mÃªs anterior
  let mesAnt=Number(mes.value)-1;
  let anoAnt=Number(ano.value);
  if(mesAnt<0){mesAnt=11;anoAnt--;}

  let comparativo=null;
  const refAnt=window.fs.doc(window.db,"resumoMensal",String(anoAnt),String(mesAnt));
  const snapAnt=await window.fs.getDocs(
    window.fs.collection(window.db,"resumoMensal",String(anoAnt))
  );

  snapAnt.forEach(s=>{
    if(s.id==mesAnt){
      const t=s.data().totalGasto||0;
      const diff=totalGasto-t;
      comparativo={
        mesAnterior:meses[mesAnt],
        totalAnterior:t,
        diferenca:diff,
        percentual:t?((diff/t)*100).toFixed(1)+'%':'100%'
      };
    }
  });

  await window.fs.setDoc(
    window.fs.doc(window.db,"resumoMensal",String(ano.value),String(mes.value)),
    {
      totalGasto,
      insumoMaisComprado:ranking[0]?.insumo||null,
      rankingInsumos:ranking,
      comparativoMesAnterior:comparativo,
      atualizadoEm:window.fs.serverTimestamp()
    }
  );

  resumoDiv.innerHTML=`
    <b>Insumo mais comprado:</b> ${ranking[0]?.insumo||'-'}<br>
    <b>Total gasto:</b> R$ ${totalGasto.toFixed(2)}<br>
    ${comparativo?`<b>Comparativo com ${comparativo.mesAnterior}:</b>
    ${comparativo.diferenca>=0?'+':''}${comparativo.diferenca.toFixed(2)} (${comparativo.percentual})`:""}
  `;
}

document.getElementById('add').onclick=()=>criarLinha();
document.getElementById('apagar').onclick=()=>{tabela.innerHTML='';};
mes.onchange=()=>{tabela.innerHTML='';atualizarResumoMensal();};
ano.onchange=()=>{tabela.innerHTML='';atualizarResumoMensal();};
</script>
</body>
</html>

