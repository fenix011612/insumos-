<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Mensal de Insumos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Poppins,Arial;background:#f5f5ff;padding:30px}
h1{text-align:center;color:#6a5acd}
.container{background:#fff;padding:20px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse}
thead{background:#6a5acd;color:#fff}
th,td{padding:8px;text-align:center}
input,select{padding:6px;border-radius:6px;border:1px solid #ccc;width:100%}
button{margin-top:10px;padding:10px;border:none;border-radius:8px;background:#4fc3f7;cursor:pointer}
.total{text-align:center;font-size:20px;margin-top:20px;color:#6a5acd;font-weight:600}
</style>

<!-- Firebase SEM module -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyByv8SN7FXTKG9kc2jJCeYGMa86R0ZVf9g",
  authDomain: "insumos-41ece.firebaseapp.com",
  databaseURL: "https://insumos-41ece-default-rtdb.firebaseio.com",
  projectId: "insumos-41ece",
  storageBucket: "insumos-41ece.firebasestorage.app",
  messagingSenderId: "25863524219",
  appId: "1:25863524219:web:59fff88398f535f84437de"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let listenerAtual = null;
</script>
</head>

<body>
<h1>Controle Mensal de Insumos</h1>

<div class="container">
  <select id="mes"></select>
  <select id="ano"></select>

  <table>
    <thead>
      <tr>
        <th>Insumo</th><th>Custo</th><th>Qtd</th><th>Data</th>
        <th>Local</th><th>Pagamento</th><th>Total</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <button onclick="adicionarLinha()">+ Adicionar</button>
  <div class="total" id="totalMes">Total do Mês: R$ 0,00</div>
</div>

<script>
const meses=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const mesSel=document.getElementById('mes');
const anoSel=document.getElementById('ano');
const tabela=document.getElementById('tabela');
const totalMes=document.getElementById('totalMes');

meses.forEach((m,i)=>mesSel.innerHTML+=`<option value="${i}">${m}</option>`);
for(let a=2024;a<=2035;a++) anoSel.innerHTML+=`<option>${a}</option>`;

mesSel.value=new Date().getMonth();
anoSel.value=new Date().getFullYear();

function caminho(){
  return `insumos/${anoSel.value}/${mesSel.value}`;
}

window.adicionarLinha=function(d={}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input value="${d.insumo||''}"></td>
    <td><input type="number" step="0.01" value="${d.custo||''}"></td>
    <td><input type="number" value="${d.quantidade||''}"></td>
    <td><input type="date" value="${d.data||''}"></td>
    <td><input value="${d.local||''}"></td>
    <td><input value="${d.pagamento||''}"></td>
    <td class="linhaTotal">0,00</td>`;
  tr.querySelectorAll('input').forEach(i=>{
    i.oninput=()=>{calcular();salvar();}
  });
  tabela.appendChild(tr);
  calcular();
}

window.calcular=function(){
  let soma=0;
  tabela.querySelectorAll('tr').forEach(tr=>{
    const c=parseFloat(tr.children[1].querySelector('input').value)||0;
    const q=parseFloat(tr.children[2].querySelector('input').value)||0;
    const t=c*q;
    tr.querySelector('.linhaTotal').innerText=t.toFixed(2);
    soma+=t;
  });
  totalMes.innerText=`Total do Mês: R$ ${soma.toFixed(2)}`;
}

window.salvar=function(){
  const dados=[];
  tabela.querySelectorAll('tr').forEach(tr=>{
    const i=tr.querySelectorAll('input');
    dados.push({
      insumo:i[0].value,custo:i[1].value,quantidade:i[2].value,
      data:i[3].value,local:i[4].value,pagamento:i[5].value
    });
  });
  db.ref(caminho()).set(dados);
}

function carregar(){
  if(listenerAtual) db.ref(listenerAtual).off();
  listenerAtual=caminho();
  db.ref(listenerAtual).on('value',snap=>{
    tabela.innerHTML='';
    if(snap.exists()) snap.val().forEach(d=>adicionarLinha(d));
    calcular();
  });
}

mesSel.onchange=carregar;
anoSel.onchange=carregar;
carregar();
</script>
</body>
</html>

